{% extends "./base.html" %} {% block main %}

<link rel="stylesheet" href="/static/css/components/citySelector.css">
<link href="/static/css/components/bootstrap-datetimepicker.min.css" rel="stylesheet" media="screen">
<script src="/static/js/echarts.js"></script>
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/china.js"></script>
<script src="/static/js/components/citySelector.js"></script>
<script src="/static/js/components/bootstrap-datetimepicker.js"></script>
<script src="/static/js/components/locales/bootstrap-datetimepicker.fr.js"></script>
<div class="wrapper wrapper-content"> 
    <div class="container">
    
        <div class="row">
            <div class="col-md-12">                        
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <span class="label label-success pull-right">总</span>
                        <h5>城市详情</h5>
                    </div>
                    <div class="ibox-content">
                        <form role="form" class="form-inline">
                            <div class="form-group">               
                                <div class='input-group date form_date' >
                                    <span class="input-group-addon input-sm">
                                        <span >城市</span>
                                    </span>
                                   <input id="citySelect" type="text" value="北京" class="form-control input-sm">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class='input-group date form_date' >
                                    <span class="input-group-addon input-sm">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                    <input name="startTm" id="datetimepicker" value="2017-06" type='text' class="form-control input-sm" readonly="readonly"/>
                                </div>
                            </div>
                        </form>
                    </div>

                    
                </div>
            </div>
        </div> 



        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>中国地图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="echarts" id="aqi_airquality"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>中国地图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="echarts" id="scatter_aqi_color"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>中国地图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content" >
                        <div class="echarts" style="height:400px;" id="radar_airquality"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>中国地图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content" style="height:440px;overflow:auto;">
                        <table id="list_airqualitys"   class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>aqi</th>
                                    <th>PM2.5</th>
                                    <th>PM10</th>
                                    <th>CO</th>
                                    <th>NO2</th>
                                    <th>SO2</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="gradeA" v-for="a in airqualitys">
                                    <td v-text="a.date"></td>
                                    <td v-text="a.aqi"></td>
                                    <td v-text="a.pm25"></td>
                                    <td v-text="a.pm10"></td>
                                    <td v-text="a.co"></td>
                                    <td v-text="a.no2"></td>
                                    <td v-text="a.so2"></td>
                                </tr>
                                <tr class="gradeA" v-7for="a in airqualitys">
                                    <td v-text="a.date"></td>
                                    <td v-text="a.aqi"></td>
                                    <td v-text="a.pm25"></td>
                                    <td v-text="a.pm10"></td>
                                    <td v-text="a.co"></td>
                                    <td v-text="a.no2"></td>
                                    <td v-text="a.so2"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>日期</th>
                                    <th>aqi</th>
                                    <th>PM2.5</th>
                                    <th>PM10</th>
                                    <th>CO</th>
                                    <th>NO2</th>
                                    <th>SO2</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>中国地图</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                            <a class="dropdown-toggle" data-toggle="dropdown" href="graph_flot.html#">
                                <i class="fa fa-wrench"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-user">
                                <li><a href="graph_flot.html#">选项1</a>
                                </li>
                                <li><a href="graph_flot.html#">选项2</a>
                                </li>
                            </ul>
                            <a class="close-link">
                                <i class="fa fa-times"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="echarts" style="height:600px" id="calendar_horizontal"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    </div>     
</div>



<script type="text/javascript">
    //月份选择器
    $('#datetimepicker').datetimepicker({
        format: 'yyyy-mm',
         weekStart: 1,
         autoclose: true,
         startView: 3,
         minView: 3,
         forceParse: false,
         language: 'zh-CN',
         initialDate: new Date()
    }).on('changeDate', function(ev){
        curMonth = $('#datetimepicker').val();
        createGraph_month(curCityName, curMonth);
    });

    //保存当前城市名称，默认北京
    var curCityName = '北京';
    var curMonth = '2017-06'

    //创建城市选择器实例
    Vcity.CitySelected = function(cityName){
        curCityName = cityName;
        createGraph_all();
    };
    var citySelect=new Vcity.CitySelector({input:'citySelect'});
    

    var aqi_airquality = echarts.init(document.getElementById("aqi_airquality"));
    var radar_airquality = echarts.init(document.getElementById("radar_airquality"));
    var scatter_aqi_color = echarts.init(document.getElementById("scatter_aqi_color"));
    var calendar_horizontal = echarts.init(document.getElementById("calendar_horizontal"));
    createGraph_all();


    var vm = new Vue({
        el: '#list_airqualitys',
        data: {
            airqualitys:  []
        },
        methods: {
        }
    });


    function createGraph_all() {
        
        createGraph_month(curCityName, curMonth);
        createGraph_year(curCityName, '2017')
    }

    function createGraph_year(cityName, year){

        function getVirtulData(year) {
            year = year || '2017';
            var date = +echarts.number.parseDate(year + '-01-01');
            var end = +echarts.number.parseDate((+year + 1) + '-01-01');
            var dayTime = 3600 * 24 * 1000;
            var data = [];
            for (var time = date; time < end; time += dayTime) {
                data.push([
                    echarts.format.formatTime('yyyy-MM-dd', time),
                    Math.floor(Math.random() * 1000)
                ]);
            }
            return data;
        }

        $.getJSON(`/api/airqualitys/city/${cityName}?year=2014`).done(function (data_2014){      
            $.getJSON(`/api/airqualitys/city/${cityName}?year=2015`).done(function (data_2015){
                $.getJSON(`/api/airqualitys/city/${cityName}?year=2016`).done(function (data_2016){
                    var data_calendar_2014 = [];
                    var data_calendar_2015 = [];
                    var data_calendar_2016 = [];

                    data_2014.airquality.map(function(item){
                        data_calendar_2014.push([
                            item.date.split('T')[0],
                            item.aqi
                        ]);
                    });
                    data_2015.airquality.map(function(item){
                        data_calendar_2015.push([
                            item.date.split('T')[0],
                            item.aqi
                        ]);
                    });
                    data_2016.airquality.map(function(item){
                        data_calendar_2016.push([
                            item.date.split('T')[0],
                            item.aqi
                        ]);
                    });

                    option_calendar = {
                        tooltip: {
                            position: 'top'
                        },
                        visualMap: {
                            min: 0,
                            max: 500,
                            calculable: true,
                            orient: 'horizontal',
                            left: 'center',
                            top: 'top'
                        },

                        calendar: [
                        {
                            range: '2016',
                            cellSize: ['auto', 20]
                        },
                        {
                            top: 260,
                            range: '2015',
                            cellSize: ['auto', 20]
                        },
                        {
                            top: 450,
                            range: '2014',
                            cellSize: ['auto', 20],
                            right: 5
                        }],

                        series: [{
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            calendarIndex: 0,
                            data: data_calendar_2016
                        }, {
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            calendarIndex: 1,
                            data: data_calendar_2015
                        }, {
                            type: 'heatmap',
                            coordinateSystem: 'calendar',
                            calendarIndex: 2,
                            data: data_calendar_2014
                        }]

                    };
                    calendar_horizontal.setOption(option_calendar);


                }).fail(function(jqXHR,textStatus){
                    alert('Error: ' + jqXHR.status);
                });
            
            }).fail(function(jqXHR,textStatus){
                alert('Error: ' + jqXHR.status);
            });

        }).fail(function(jqXHR,textStatus){
            alert('Error: ' + jqXHR.status);
        });

    }    

    function createGraph_month(cityName, month){
         $.getJSON(`/api/airqualitys/city/${cityName}?month=${month}`).done(function (data){
            vm.airqualitys = []; //初始化及清空
            var data_radar = [];//date,AQIindex,PM2.5,PM10,CO,NO2,SO2
            var data_scatter = [];
            var max_aqi=0,
                max_pm25=0,
                max_pm10=0,
                max_co=0,
                max_no2=0,
                max_so2=0;
            
            data.airquality.map(function (item, index) {
                item.date = item.date ? item.date.split('T')[0] : '1995.08.13';
                vm.airqualitys.push(item);
                max_aqi= max_aqi>item.aqi?max_aqi:item.aqi;
                max_pm25= max_pm25>item.pm25?max_pm25:item.pm25;
                max_pm10= max_pm10>item.pm10?max_pm10:item.pm10;
                max_co= max_co>item.co?max_co:item.co;
                max_no2= max_no2>item.no2?max_no2:item.no2;
                max_so2= max_so2>item.so2?max_so2:item.so2;
                data_radar.push([
                    item.aqi,
                    item.pm25,
                    item.pm10,
                    item.co,
                    item.no2,
                    item.so2,
                    index
                ]);
                data_scatter.push([
                    index,
                    item.aqi,
                    item.pm25,
                    item.pm10,
                    item.co,
                    item.no2,
                    item.so2
                ]);
            });


            aqi_airquality.hideLoading();
            radar_airquality.hideLoading();
            option_aqi = {
                title: {
                    text: curCityName + '空气质量',
                    top: 20,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    data: data.airquality.map(function (item) {
                        return item.date.split('T')[0];
                    })
                },
                yAxis: {
                    splitLine: {
                        show: false
                    }
                },
                dataZoom: [{
                    type: 'inside'
                }],
                visualMap: {
                    top: 10,
                    right: 0,
                    pieces: [{
                        gt: 0,
                        lte: 50,
                        color: '#096'
                    }, {
                        gt: 50,
                        lte: 100,
                        color: '#ffde33'
                    }, {
                        gt: 100,
                        lte: 150,
                        color: '#ff9933'
                    }, {
                        gt: 150,
                        lte: 200,
                        color: '#cc0033'
                    }, {
                        gt: 200,
                        lte: 300,
                        color: '#660099'
                    }, {
                        gt: 300,
                        color: '#7e0023'
                    }],
                    outOfRange: {
                        color: '#999'
                    }
                },
                series: {
                    name: 'Beijing AQI',
                    type: 'line',
                    data: data.airquality.map(function (item) {
                        return item.aqi;
                    }),
                    markLine: {
                        silent: true,
                        data: [{
                            yAxis: 50
                        }, {
                            yAxis: 100
                        }, {
                            yAxis: 150
                        }, {
                            yAxis: 200
                        }, {
                            yAxis: 300
                        }]
                    }
                }       
            };
            aqi_airquality.setOption(option_aqi);

            // Schema:
            // date,AQIindex,PM2.5,PM10,CO,NO2,SO2
            var dataBJ = [
                [55,9,56,0.46,18,6,1],
                [25,11,21,0.65,34,9,2],
                [56,7,63,0.3,14,5,3],
                [33,7,29,0.33,16,6,4],
                [42,24,44,0.76,40,16,5],
                [82,58,90,1.77,68,33,6],
                [74,49,77,1.46,48,27,7],
                [78,55,80,1.29,59,29,8],
                [267,216,280,4.8,108,64,9],
                [185,127,216,2.52,61,27,10],
                [39,19,38,0.57,31,15,11],
                [41,11,40,0.43,21,7,12],
                [64,38,74,1.04,46,22,13],
                [108,79,120,1.7,75,41,14],
                [108,63,116,1.48,44,26,15],
                [33,6,29,0.34,13,5,16],
                [94,66,110,1.54,62,31,17],
                [186,142,192,3.88,93,79,18],
                [57,31,54,0.96,32,14,19],
                [22,8,17,0.48,23,10,20],
                [39,15,36,0.61,29,13,21],
                [94,69,114,2.08,73,39,22],
                [99,73,110,2.43,76,48,23],
                [31,12,30,0.5,32,16,24],
                [42,27,43,1,53,22,25],
                [154,117,157,3.05,92,58,26],
                [234,185,230,4.09,123,69,27],
                [160,120,186,2.77,91,50,28],
                [134,96,165,2.76,83,41,29],
                [52,24,60,1.03,50,21,30],
                [46,5,49,0.28,10,6,31]
            ];


            var lineStyle = {
                normal: {
                    width: 1,
                    opacity: 0.5
                }
            };

            option_radar = {

                // visualMap: {
                //     show: true,
                //     min: 0,
                //     max: 20,
                //     dimension: 6,
                //     inRange: {
                //         colorLightness: [0.5, 0.8]
                //     }
                // },

                radar: {
                    indicator: [
                        {name: 'AQI', max: max_aqi  },
                        {name: 'PM2.5', max: max_pm25 },
                        {name: 'PM10', max: max_pm10 },
                        {name: 'CO', max: max_co },
                        {name: 'NO2', max: max_no2 },
                        {name: 'SO2', max: max_so2 }
                    ],
                    shape: 'circle',
                    splitNumber: 5,
                    name: {
                        textStyle: {
                            color: 'rgb(238, 197, 102)'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: [
                                'rgba(238, 197, 102, 0.1)', 'rgba(238, 197, 102, 0.2)',
                                'rgba(238, 197, 102, 0.4)', 'rgba(238, 197, 102, 0.6)',
                                'rgba(238, 197, 102, 0.8)', 'rgba(238, 197, 102, 1)'
                            ].reverse()
                        }
                    },
                    splitArea: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: 'rgba(238, 197, 102, 0.5)'
                        }
                    }
                },
                series: [
                    {
                        name: '北京',
                        type: 'radar',
                        lineStyle: lineStyle,
                        data: data_radar,
                        symbol: 'none',
                        itemStyle: {
                            normal: {
                                color: '#F9713C'
                            }
                        },
                        areaStyle: {
                            normal: {
                                opacity: 0.1
                            }
                        }
                    }
                ]
            };
            radar_airquality.setOption(option_radar);


            var schema_scatter = [
                {name: 'date', index: 0, text: '日'},
                {name: 'AQIindex', index: 1, text: 'AQI指数'},
                {name: 'PM25', index: 2, text: 'PM2.5'},
                {name: 'PM10', index: 3, text: 'PM10'},
                {name: 'CO', index: 4, text: '一氧化碳（CO）'},
                {name: 'NO2', index: 5, text: '二氧化氮（NO2）'},
                {name: 'SO2', index: 6, text: '二氧化硫（SO2）'}
            ];


            var itemStyle_scatter = {
                normal: {
                    opacity: 0.8,
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowOffsetY: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            };

            option_scatter = {
                backgroundColor: '#404a59',
                color: [
                    '#dd4444', '#fec42c', '#80F1BE'
                ],
                legend: {
                    y: 'top',
                    data: [cityName],
                    textStyle: {
                        color: '#fff',
                        fontSize: 16
                    }
                },
                grid: {
                    x: '10%',
                    x2: 150,
                    y: '18%',
                    y2: '10%'
                },
                tooltip: {
                    padding: 10,
                    backgroundColor: '#222',
                    borderColor: '#777',
                    borderWidth: 1,
                    formatter: function (obj) {
                        var value = obj.value;
                        return '<div style="border-bottom: 1px solid rgba(255,255,255,.3); font-size: 18px;padding-bottom: 7px;margin-bottom: 7px">'
                            + obj.seriesName + ' ' + value[0] + '日：'
                            + value[7]
                            + '</div>'
                            + schema_scatter[1].text + '：' + value[1] + '<br>'
                            + schema_scatter[2].text + '：' + value[2] + '<br>'
                            + schema_scatter[3].text + '：' + value[3] + '<br>'
                            + schema_scatter[4].text + '：' + value[4] + '<br>'
                            + schema_scatter[5].text + '：' + value[5] + '<br>'
                            + schema_scatter[6].text + '：' + value[6] + '<br>';
                    }
                },
                xAxis: {
                    type: 'value',
                    name: '日期',
                    nameGap: 16,
                    nameTextStyle: {
                        color: '#fff',
                        fontSize: 14
                    },
                    max: 31,
                    splitLine: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#eee'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'AQI指数',
                    nameLocation: 'end',
                    nameGap: 20,
                    nameTextStyle: {
                        color: '#fff',
                        fontSize: 16
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#eee'
                        }
                    },
                    splitLine: {
                        show: false
                    }
                },
                visualMap: [
                    {
                        right: '10%',
                        top: '5%',
                        dimension: 2,
                        min: 0,
                        max: 250,
                        itemWidth: 20,
                        itemHeight: 80,
                        calculable: true,
                        precision: 0.1,
                        text: ['圆形大小：PM2.5'],
                        textGap: 30,
                        textStyle: {
                            color: '#fff'
                        },
                        inRange: {
                            symbolSize: [10, 70]
                        },
                        outOfRange: {
                            symbolSize: [10, 70],
                            color: ['rgba(255,255,255,.2)']
                        },
                        controller: {
                            inRange: {
                                color: ['#c23531']
                            },
                            outOfRange: {
                                color: ['#444']
                            }
                        }
                    },
                    {
                        right: '1%',
                        top: '5%',
                        dimension: 6,
                        min: 0,
                        max: 50,
                        itemHeight: 80,
                        calculable: true,
                        precision: 0.1,
                        text: ['明暗：二氧化硫'],
                        textGap: 30,
                        textStyle: {
                            color: '#fff'
                        },
                        inRange: {
                            colorLightness: [1, 0.5]
                        },
                        outOfRange: {
                            color: ['rgba(255,255,255,.2)']
                        },
                        controller: {
                            inRange: {
                                color: ['#c23531']
                            },
                            outOfRange: {
                                color: ['#444']
                            }
                        }
                    }
                ],
                series: [
                    {
                        name: cityName,
                        type: 'scatter',
                        itemStyle: itemStyle_scatter,
                        data: data_scatter
                    }
                ]
            };
            scatter_aqi_color.setOption(option_scatter);


            function getVirtulData(year) {
                year = year || '2017';
                var date = +echarts.number.parseDate(year + '-01-01');
                var end = +echarts.number.parseDate((+year + 1) + '-01-01');
                var dayTime = 3600 * 24 * 1000;
                var data = [];
                for (var time = date; time < end; time += dayTime) {
                    data.push([
                        echarts.format.formatTime('yyyy-MM-dd', time),
                        Math.floor(Math.random() * 1000)
                    ]);
                }
                return data;
            }



            option_calendar = {
                tooltip: {
                    position: 'top'
                },
                visualMap: {
                    min: 0,
                    max: 1000,
                    calculable: true,
                    orient: 'horizontal',
                    left: 'center',
                    top: 'top'
                },

                calendar: [
                {
                    range: '2017',
                    cellSize: ['auto', 20]
                },
                {
                    top: 260,
                    range: '2016',
                    cellSize: ['auto', 20]
                },
                {
                    top: 450,
                    range: '2015',
                    cellSize: ['auto', 20],
                    right: 5
                }],

                series: [{
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    calendarIndex: 0,
                    data: getVirtulData(2017)
                }, {
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    calendarIndex: 1,
                    data: getVirtulData(2016)
                }, {
                    type: 'heatmap',
                    coordinateSystem: 'calendar',
                    calendarIndex: 2,
                    data: getVirtulData(2015)
                }]

            };
            calendar_horizontal.setOption(option_calendar);

        }).fail(function(jqXHR,textStatus){
            alert('Error: ' + jqXHR.status);
        });

    }

       


</script>

{% endblock %}